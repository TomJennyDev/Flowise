name: Build and Push Flowise Images

on:
    workflow_dispatch:
        inputs:
            environment:
                description: 'Environment to deploy'
                type: choice
                required: true
                default: 'dev'
                options:
                    - dev
                    - staging
                    - production
            node_version:
                description: 'Node.js version'
                type: choice
                required: true
                default: '20'
                options:
                    - '20'
    push:
        branches:
            - main
        paths:
            - 'packages/**'
            - 'Dockerfile'
            - '.github/workflows/deploy-to-k8s.yml'

env:
    AWS_REGION: ap-southeast-1
    GITOPS_REPO: TomJennyDev/devops

jobs:
    # ============================================
    # Job 1: Set Environment Variables
    # ============================================
    set-env:
        name: Set Environment
        runs-on: ubuntu-latest
        outputs:
            tag: ${{ steps.set-vars.outputs.tag }}
            env: ${{ steps.set-vars.outputs.env }}
            node_version: ${{ steps.set-vars.outputs.node_version }}
        steps:
            - name: Set variables
              id: set-vars
              run: |
                  # Get short SHA for tagging (7 chars)
                  SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

                  # Determine environment and Node version
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                      ENV="${{ github.event.inputs.environment }}"
                      NODE_VERSION="${{ github.event.inputs.node_version }}"
                  else
                      # Auto-trigger from main branch - deploy to DEV only
                      ENV="dev"
                      NODE_VERSION="20"
                  fi

                  # Tag is always the short SHA
                  TAG="${SHORT_SHA}"

                  echo "tag=${TAG}" >> $GITHUB_OUTPUT
                  echo "env=${ENV}" >> $GITHUB_OUTPUT
                  echo "node_version=${NODE_VERSION}" >> $GITHUB_OUTPUT

                  echo "ğŸ·ï¸ Tag: ${TAG}"
                  echo "ğŸ”– Full SHA: ${{ github.sha }}"
                  echo "ğŸŒ Environment: ${ENV}"
                  echo "ğŸ“¦ Node Version: ${NODE_VERSION}"

    # ============================================
    # Job 2: Build and Push Server Image
    # ============================================
    build-server:
        name: Build Server Image
        needs: set-env
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        outputs:
            image_uri: ${{ steps.image-uri.outputs.uri }}
            image_digest: ${{ steps.get-digest.outputs.digest }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # Configure AWS credentials
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set image URI
              id: image-uri
              run: |
                  REGISTRY="${{ steps.login-ecr.outputs.registry }}"
                  IMAGE_URI="${REGISTRY}/flowise-server:${{ needs.set-env.outputs.tag }}"
                  echo "uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ Server Image: ${IMAGE_URI}"
                  echo "ğŸ·ï¸ Additional tags: latest, ${{ github.sha }}"

            - name: Build and push Server image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./packages/server/Dockerfile
                  build-args: |
                      NODE_VERSION=${{ needs.set-env.outputs.node_version }}
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ steps.image-uri.outputs.uri }}
                      ${{ steps.login-ecr.outputs.registry }}/flowise-server:latest
                      ${{ steps.login-ecr.outputs.registry }}/flowise-server:${{ github.sha }}
                  cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/flowise-server:buildcache
                  cache-to: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/flowise-server:buildcache,mode=max

            # Get image digest for immutable reference
            - name: Get image digest
              id: get-digest
              env:
                  AWS_REGION: ${{ env.AWS_REGION }}
              run: |
                  echo "ğŸ” Getting image digest from ECR..."

                  DIGEST=$(aws ecr describe-images \
                      --repository-name flowise-server \
                      --image-ids imageTag=${{ needs.set-env.outputs.tag }} \
                      --region ${AWS_REGION} \
                      --query 'imageDetails[0].imageDigest' \
                      --output text)

                  echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
                  echo "âœ… Image Digest: ${DIGEST}"

    # ============================================
    # Job 3: Build and Push UI Image
    # ============================================
    build-ui:
        name: Build UI Image
        needs: set-env
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        outputs:
            image_uri: ${{ steps.image-uri.outputs.uri }}
            image_digest: ${{ steps.get-digest.outputs.digest }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set image URI
              id: image-uri
              run: |
                  REGISTRY="${{ steps.login-ecr.outputs.registry }}"
                  IMAGE_URI="${REGISTRY}/flowise-ui:${{ needs.set-env.outputs.tag }}"
                  echo "uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ UI Image: ${IMAGE_URI}"
                  echo "ğŸ·ï¸ Additional tags: latest, ${{ github.sha }}"

            - name: Build and push UI image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./packages/ui/Dockerfile
                  build-args: |
                      NODE_VERSION=${{ needs.set-env.outputs.node_version }}
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ steps.image-uri.outputs.uri }}
                      ${{ steps.login-ecr.outputs.registry }}/flowise-ui:latest
                      ${{ steps.login-ecr.outputs.registry }}/flowise-ui:${{ github.sha }}
                  cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/flowise-ui:buildcache
                  cache-to: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/flowise-ui:buildcache,mode=max

            # Get image digest for immutable reference
            - name: Get image digest
              id: get-digest
              env:
                  AWS_REGION: ${{ env.AWS_REGION }}
              run: |
                  echo "ğŸ” Getting image digest from ECR..."

                  DIGEST=$(aws ecr describe-images \
                      --repository-name flowise-ui \
                      --image-ids imageTag=${{ needs.set-env.outputs.tag }} \
                      --region ${AWS_REGION} \
                      --query 'imageDetails[0].imageDigest' \
                      --output text)

                  echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
                  echo "âœ… Image Digest: ${DIGEST}"

    # ============================================
    # Job 4: Trigger DevOps Repo to Update Deployment
    # ============================================
    trigger-gitops-repo:
        name: Trigger DevOps Repo
        needs: [set-env, build-server, build-ui]
        runs-on: ubuntu-latest
        steps:
            - name: Trigger repository_dispatch to DevOps repo
              uses: peter-evans/repository-dispatch@v3
              with:
                  token: ${{ secrets.GITOPS_TOKEN }}
                  repository: ${{ env.GITOPS_REPO }}
                  event-type: flowise-image-updated
                  client-payload: |
                      {
                        "environment": "${{ needs.set-env.outputs.env }}",
                        "tag": "${{ needs.set-env.outputs.tag }}",
                        "sha": "${{ github.sha }}",
                        "server_digest": "${{ needs.build-server.outputs.image_digest }}",
                        "ui_digest": "${{ needs.build-ui.outputs.image_digest }}",
                        "actor": "${{ github.actor }}",
                        "workflow_run_id": "${{ github.run_id }}"
                      }

            - name: Deployment triggered
              run: |
                  echo "âœ… Triggered DevOps repo to update deployment"
                  echo ""
                  echo "ğŸ“¦ Images built:"
                  echo "  Server: ${{ needs.build-server.outputs.image_uri }}"
                  echo "  Server Digest: ${{ needs.build-server.outputs.image_digest }}"
                  echo "  UI: ${{ needs.build-ui.outputs.image_uri }}"
                  echo "  UI Digest: ${{ needs.build-ui.outputs.image_digest }}"
                  echo ""
                  echo "ğŸ·ï¸ Tag: ${{ needs.set-env.outputs.tag }}"
                  echo "ğŸŒ Environment: ${{ needs.set-env.outputs.env }}"
                  echo "ğŸ”– SHA: ${{ github.sha }}"
                  echo ""
                  echo "ğŸ“¡ DevOps repo will receive the trigger and update kustomization.yaml"
                  echo "ğŸ”„ ArgoCD will auto-sync and deploy the new images to EKS"
